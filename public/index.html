<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Financial Analysis Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .loading, .result { display: none; }
    .loading.active, .result.active { display: block; }
  </style>
</head>
<body class="min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <div class="max-w-3xl mx-auto">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-3xl font-bold text-gray-900 mb-6">Financial Analysis Tool</h1>

        <!-- Auth section -->
        <div class="mb-4">
          <div id="auth-status" class="text-sm text-gray-700 mb-4">Please sign in to analyze stocks</div>
          <div id="auth-form" class="space-y-4">
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
              <input type="email" id="email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>
            <div>
              <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
              <input type="password" id="password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>
            <div class="flex gap-2">
              <button id="login-btn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Sign In</button>             
              <button id="logout-btn" class="bg-red-600 text-white px-4 py-2 rounded hidden hover:bg-red-700">Sign Out</button>
            </div>
          </div>
        </div>

        <div id="ticker-section" class="mb-6 hidden">
          <label for="ticker" class="block text-sm font-medium text-gray-700 mb-2">Stock Ticker Symbol</label>
          <div class="flex gap-2">
            <input type="text" id="ticker" name="ticker" 
              class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              placeholder="e.g., AAPL">
            <button onclick="analyzeStock()" 
              class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
              Analyze
            </button>
          </div>
        </div>

        <div id="loading" class="loading">
          <div class="flex items-center justify-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <span class="ml-2 text-gray-600">Analyzing stock data...</span>
          </div>
        </div>

        <div id="result" class="result">
          <div class="border-t border-gray-200 pt-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Analysis Results</h2>
            <div id="result-content" class="prose max-w-none"></div>
          </div>
        </div>

        <div id="error" class="hidden mt-4 p-4 bg-red-50 text-red-700 rounded-md"></div>
      </div>
    </div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDTVrNzD-YYFnvqakAk1LysPe8jPrpyScc",
      authDomain: "fintech-ash-80b97.firebaseapp.com",
      projectId: "fintech-ash-80b97",
      storageBucket: "fintech-ash-80b97.appspot.com",
      messagingSenderId: "972685478512",
      appId: "1:972685478512:web:34d1aa305be183112702b5",
      measurementId: "G-FHFL400HD3"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const analytics = firebase.analytics();

    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const authStatus = document.getElementById('auth-status');
    const tickerSection = document.getElementById('ticker-section');

    auth.onAuthStateChanged(user => {
      if (user) {
        authStatus.textContent = `Signed in as ${user.email}`;
        loginBtn.classList.add('hidden');
        logoutBtn.classList.remove('hidden');
        tickerSection.classList.remove('hidden');
      } else {
        authStatus.textContent = 'Please sign in to analyze stocks';
        loginBtn.classList.remove('hidden');
        logoutBtn.classList.add('hidden');
        tickerSection.classList.add('hidden');
      }
    });

    loginBtn.onclick = async () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      if (!email || !password) {
        showError('Please enter both email and password');
        return;
      }

      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (error) {
        showError(error.message);
      }
    };

    logoutBtn.onclick = () => auth.signOut();

    
    async function analyzeStock() {
      const ticker = document.getElementById('ticker').value.trim().toUpperCase();
      if (!ticker) return showError('Please enter a ticker symbol');

      const user = firebase.auth().currentUser;
      if (!user) return showError('You must be signed in to analyze stocks.');

      const token = await user.getIdToken();

      document.getElementById('loading').classList.add('active');
      document.getElementById('result').classList.remove('active');
      document.getElementById('error').classList.add('hidden');

      try {
        analytics.logEvent('analyze_stock', { ticker });

        const response = await fetch('https://us-central1-fintech-ash-80b97.cloudfunctions.net/analyze_stock_endpoint', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ ticker }),
        });

        const data = await response.json();

        if (!response.ok) throw new Error(data.error || 'An error occurred');

        document.getElementById('result-content').innerHTML = formatResults(data);
        document.getElementById('result').classList.add('active');

      } catch (error) {
        showError(error.message);
        analytics.logEvent('analyze_stock_error', { ticker, error: error.message });
      } finally {
        document.getElementById('loading').classList.remove('active');
      }
    }

    function formatResults(data) {
      let html = '';
      if (data.financial_metrics) {
        html += '<h3 class="text-lg font-semibold mb-2">Financial Metrics</h3><div class="grid grid-cols-2 gap-4 mb-4">';
        for (const [key, value] of Object.entries(data.financial_metrics)) {
          html += `
            <div class="bg-gray-50 p-3 rounded-md">
              <div class="text-sm text-gray-600">${key}</div>
              <div class="font-medium">${value}</div>
            </div>`;
        }
        html += '</div>';
      }
      if (data.analysis_summary) {
        html += `<h3 class="text-lg font-semibold mb-2">Analysis Summary</h3>
                 <div class="bg-gray-50 p-4 rounded-md">${data.analysis_summary}</div>`;
      }
      return html;
    }

    function showError(message) {
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
    }
  </script>
</body>
</html>
